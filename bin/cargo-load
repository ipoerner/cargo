#!/bin/sh

set -e

case $# in
    1)
    VISIBILITY="public"
    PROJECT=${1}
    ;;
    2)
    VISIBILITY=${1}
    PROJECT=${2}
    ;;
    *)
    echo "Usage: cargo-load [<project-visibility>] <project-name>"
    exit 1
    ;;
esac

IMAGE_NAME="build-env-${PROJECT}"
SCRIPT=$(readlink -f "$0")
SCRIPTPATH=$(dirname "$SCRIPT")

mkdir -p ${SCRIPTPATH}/../${VISIBILITY}/${PROJECT}/env
cp -f ${SCRIPTPATH}/../env/* ${SCRIPTPATH}/../${VISIBILITY}/${PROJECT}/env/

mkdir -p ${SCRIPTPATH}/../${VISIBILITY}/${PROJECT}/config
(cd ${SCRIPTPATH}/../config
for file in `ls -AL -I .gitignore`; do
    cp -f $file ${SCRIPTPATH}/../${VISIBILITY}/${PROJECT}/config/
done
)

mkdir -p ${SCRIPTPATH}/../${VISIBILITY}/${PROJECT}/ssh
(cd ${SCRIPTPATH}/../ssh
for file in `ls -AL -I .gitignore`; do
    cp -f $file ${SCRIPTPATH}/../${VISIBILITY}/${PROJECT}/ssh/
done
)

sudo docker build \
    --tag ${IMAGE_NAME} \
    --force-rm \
    ${SCRIPTPATH}/../${VISIBILITY}/${PROJECT}
