#!/bin/sh

set -e

SCRIPT=$(readlink -f "$0")
SCRIPTPATH=$(dirname "$SCRIPT")
CONFIG_DIR="${SCRIPTPATH}/../config"
SSH_DIR="${SCRIPTPATH}/../config/.ssh"

case $# in
    0)
    PROJECT=${PWD##*/}
    IMAGE_NAME="cargo/env-${PROJECT}"
    ;;
    1)
    PROJECT=${1}
    IMAGE_NAME="cargo/env-${PROJECT}"
    ;;
    *)
    echo "Usage: cargo-load [<project-name>]"
    exit 1
    ;;
esac

for file in `find ${CONFIG_DIR} -maxdepth 1 -not -type d | grep -v .gitignore`; do
    mkdir -p config
    cp -f $file config/
done

for file in `ls -AL -I .gitignore ${SSH_DIR}`; do
    mkdir -p config/.ssh
    cp -f ${SSH_DIR}/$file config/.ssh/
done

sudo docker build \
    --tag ${IMAGE_NAME} \
    --force-rm \
    .
